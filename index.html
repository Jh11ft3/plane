<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AeroSim - 真实飞行模拟器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>
  
  <!-- 配置Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0071e3',
            secondary: '#34c759',
            danger: '#ff3b30',
            dark: '#1c1c1e',
            light: '#f5f5f7',
          },
          fontFamily: {
            sans: ['SF Pro Display', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .glass {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .glass-dark {
        background: rgba(28, 28, 30, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .text-shadow {
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
      .animate-pulse-slow {
        animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      .animate-float {
        animation: float 6s ease-in-out infinite;
      }
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
      }
      .cockpit-gauge {
        clip-path: polygon(0 0, 100% 0, 100% 85%, 50% 100%, 0 85%);
      }
      .btn-glass {
        @apply glass hover:bg-white/20 transition-all duration-300 ease-in-out;
      }
      .btn-glass-dark {
        @apply glass-dark hover:bg-white/10 transition-all duration-300 ease-in-out;
      }
    }
  </style>
</head>

<body class="font-sans bg-black text-white overflow-hidden h-screen w-screen">
  <!-- 游戏容器 -->
  <div id="game-container" class="relative h-full w-full">
    <!-- 3D渲染区域 -->
    <canvas id="game-canvas" class="absolute inset-0 w-full h-full"></canvas>
    
    <!-- 加载屏幕 -->
    <div id="loading-screen" class="absolute inset-0 glass-dark z-50 flex flex-col items-center justify-center transition-opacity duration-1000">
      <div class="w-24 h-24 rounded-full border-4 border-primary border-t-transparent animate-spin mb-6"></div>
      <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-2 text-white text-shadow">AeroSim</h1>
      <p class="text-gray-300 mb-6">加载飞行环境中...</p>
      <div class="w-64 h-2 bg-white/20 rounded-full overflow-hidden">
        <div id="loading-progress" class="h-full bg-primary rounded-full w-0 transition-all duration-300"></div>
      </div>
    </div>
    
    <!-- 主菜单 -->
    <div id="main-menu" class="absolute inset-0 glass-dark z-40 flex flex-col items-center justify-center transition-all duration-700 transform translate-x-0">
      <div class="text-center mb-12">
        <h1 class="text-[clamp(2.5rem,5vw,4rem)] font-bold text-white text-shadow mb-2">AeroSim</h1>
        <p class="text-gray-300 text-lg">真实飞行模拟体验</p>
      </div>
      
      <div class="flex flex-col gap-4 w-[clamp(280px,50vw,400px)]">
        <button id="start-game" class="btn-glass text-white py-4 px-6 rounded-xl text-lg font-medium flex items-center justify-center gap-2 hover:scale-105 transition-all duration-300">
          <i class="fa fa-play"></i> 开始飞行
        </button>
        <button id="select-plane" class="btn-glass text-white py-4 px-6 rounded-xl text-lg font-medium flex items-center justify-center gap-2 hover:scale-105 transition-all duration-300">
          <i class="fa fa-plane"></i> 选择飞机
        </button>
        <button id="select-airport" class="btn-glass text-white py-4 px-6 rounded-xl text-lg font-medium flex items-center justify-center gap-2 hover:scale-105 transition-all duration-300">
          <i class="fa fa-map-marker"></i> 选择机场
        </button>
        <button id="settings" class="btn-glass text-white py-4 px-6 rounded-xl text-lg font-medium flex items-center justify-center gap-2 hover:scale-105 transition-all duration-300">
          <i class="fa fa-cog"></i> 设置
        </button>
      </div>
      
      <div class="absolute bottom-8 left-0 right-0 text-center text-gray-400 text-sm">
        <p>© 2023 AeroSim 飞行模拟器 | 按 ESC 返回菜单</p>
      </div>
    </div>
    
    <!-- 飞机选择菜单 -->
    <div id="plane-selector" class="absolute inset-0 glass-dark z-40 transform translate-x-full transition-transform duration-700 flex flex-col">
      <div class="p-6 flex justify-between items-center">
        <h2 class="text-2xl font-bold">选择飞机</h2>
        <button id="back-from-plane" class="btn-glass p-3 rounded-full hover:scale-110 transition-transform">
          <i class="fa fa-arrow-left"></i>
        </button>
      </div>
      
      <div class="flex-1 overflow-y-auto p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="plane-card glass rounded-xl overflow-hidden cursor-pointer hover:scale-105 transition-all duration-300 border-2 border-transparent hover:border-primary" data-plane="cessna">
          <div class="h-48 bg-gray-800 relative overflow-hidden">
            <img src="https://picsum.photos/id/1011/600/400" alt="塞斯纳172" class="w-full h-full object-cover">
            <div class="absolute top-3 right-3 bg-primary text-white text-xs py-1 px-3 rounded-full">
              单引擎
            </div>
          </div>
          <div class="p-4">
            <h3 class="font-bold text-lg">塞斯纳 172</h3>
            <p class="text-gray-300 text-sm mt-1">经典训练机，易于操作</p>
            <div class="mt-3 flex justify-between items-center">
              <div class="flex items-center gap-1 text-yellow-400">
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
                <i class="fa fa-star-half-o"></i>
              </div>
              <span class="text-sm text-gray-400">最大速度: 226 km/h</span>
            </div>
          </div>
        </div>
        
        <div class="plane-card glass rounded-xl overflow-hidden cursor-pointer hover:scale-105 transition-all duration-300 border-2 border-transparent hover:border-primary" data-plane="boeing737">
          <div class="h-48 bg-gray-800 relative overflow-hidden">
            <img src="https://picsum.photos/id/1015/600/400" alt="波音737" class="w-full h-full object-cover">
            <div class="absolute top-3 right-3 bg-primary text-white text-xs py-1 px-3 rounded-full">
              民航客机
            </div>
          </div>
          <div class="p-4">
            <h3 class="font-bold text-lg">波音 737-800</h3>
            <p class="text-gray-300 text-sm mt-1">主流民航客机，适合长途飞行</p>
            <div class="mt-3 flex justify-between items-center">
              <div class="flex items-center gap-1 text-yellow-400">
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
              </div>
              <span class="text-sm text-gray-400">最大速度: 945 km/h</span>
            </div>
          </div>
        </div>
        
        <div class="plane-card glass rounded-xl overflow-hidden cursor-pointer hover:scale-105 transition-all duration-300 border-2 border-transparent hover:border-primary" data-plane="f16">
          <div class="h-48 bg-gray-800 relative overflow-hidden">
            <img src="https://picsum.photos/id/1019/600/400" alt="F-16战斗机" class="w-full h-full object-cover">
            <div class="absolute top-3 right-3 bg-danger text-white text-xs py-1 px-3 rounded-full">
              战斗机
            </div>
          </div>
          <div class="p-4">
            <h3 class="font-bold text-lg">F-16 战隼</h3>
            <p class="text-gray-300 text-sm mt-1">高性能战斗机，机动性极佳</p>
            <div class="mt-3 flex justify-between items-center">
              <div class="flex items-center gap-1 text-yellow-400">
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
                <i class="fa fa-star"></i>
                <i class="fa fa-star-o"></i>
              </div>
              <span class="text-sm text-gray-400">最大速度: 2,175 km/h</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 机场选择菜单 -->
    <div id="airport-selector" class="absolute inset-0 glass-dark z-40 transform translate-x-full transition-transform duration-700 flex flex-col">
      <div class="p-6 flex justify-between items-center">
        <h2 class="text-2xl font-bold">选择机场</h2>
        <button id="back-from-airport" class="btn-glass p-3 rounded-full hover:scale-110 transition-transform">
          <i class="fa fa-arrow-left"></i>
        </button>
      </div>
      
      <div class="flex-1 overflow-y-auto p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="airport-card glass rounded-xl overflow-hidden cursor-pointer hover:scale-105 transition-all duration-300 border-2 border-transparent hover:border-primary" data-airport="jfk">
          <div class="h-40 bg-gray-800 relative overflow-hidden">
            <img src="https://picsum.photos/id/1031/600/300" alt="JFK机场" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
            <div class="absolute bottom-3 left-3 text-white">
              <h4 class="font-bold">JFK 肯尼迪国际机场</h4>
              <p class="text-sm">纽约, 美国</p>
            </div>
          </div>
          <div class="p-4 flex justify-between items-center">
            <div>
              <span class="text-xs text-gray-400">ICAO: KJFK</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs bg-gray-700 px-2 py-1 rounded">4条跑道</span>
              <span class="text-xs bg-gray-700 px-2 py-1 rounded">大型机场</span>
            </div>
          </div>
        </div>
        
        <div class="airport-card glass rounded-xl overflow-hidden cursor-pointer hover:scale-105 transition-all duration-300 border-2 border-transparent hover:border-primary" data-airport="heathrow">
          <div class="h-40 bg-gray-800 relative overflow-hidden">
            <img src="https://picsum.photos/id/1032/600/300" alt="希思罗机场" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
            <div class="absolute bottom-3 left-3 text-white">
              <h4 class="font-bold">希思罗国际机场</h4>
              <p class="text-sm">伦敦, 英国</p>
            </div>
          </div>
          <div class="p-4 flex justify-between items-center">
            <div>
              <span class="text-xs text-gray-400">ICAO: EGLL</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs bg-gray-700 px-2 py-1 rounded">2条跑道</span>
              <span class="text-xs bg-gray-700 px-2 py-1 rounded">大型机场</span>
            </div>
          </div>
        </div>
        
        <div class="airport-card glass rounded-xl overflow-hidden cursor-pointer hover:scale-105 transition-all duration-300 border-2 border-transparent hover:border-primary" data-airport="shanghai">
          <div class="h-40 bg-gray-800 relative overflow-hidden">
            <img src="https://picsum.photos/id/1033/600/300" alt="浦东机场" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
            <div class="absolute bottom-3 left-3 text-white">
              <h4 class="font-bold">浦东国际机场</h4>
              <p class="text-sm">上海, 中国</p>
            </div>
          </div>
          <div class="p-4 flex justify-between items-center">
            <div>
              <span class="text-xs text-gray-400">ICAO: ZSPD</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs bg-gray-700 px-2 py-1 rounded">4条跑道</span>
              <span class="text-xs bg-gray-700 px-2 py-1 rounded">大型机场</span>
            </div>
          </div>
        </div>
        
        <div class="airport-card glass rounded-xl overflow-hidden cursor-pointer hover:scale-105 transition-all duration-300 border-2 border-transparent hover:border-primary" data-airport="alps">
          <div class="h-40 bg-gray-800 relative overflow-hidden">
            <img src="https://picsum.photos/id/1036/600/300" alt="阿尔卑斯机场" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
            <div class="absolute bottom-3 left-3 text-white">
              <h4 class="font-bold">阿尔卑斯山区机场</h4>
              <p class="text-sm">因斯布鲁克, 奥地利</p>
            </div>
          </div>
          <div class="p-4 flex justify-between items-center">
            <div>
              <span class="text-xs text-gray-400">ICAO: LOWI</span>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs bg-gray-700 px-2 py-1 rounded">1条跑道</span>
              <span class="text-xs bg-gray-700 px-2 py-1 rounded">挑战性</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 设置菜单 -->
    <div id="settings-menu" class="absolute inset-0 glass-dark z-40 transform translate-x-full transition-transform duration-700 flex flex-col">
      <div class="p-6 flex justify-between items-center">
        <h2 class="text-2xl font-bold">设置</h2>
        <button id="back-from-settings" class="btn-glass p-3 rounded-full hover:scale-110 transition-transform">
          <i class="fa fa-arrow-left"></i>
        </button>
      </div>
      
      <div class="flex-1 overflow-y-auto p-6">
        <div class="mb-8">
          <h3 class="text-xl font-semibold mb-4">图形设置</h3>
          <div class="space-y-4">
            <div class="glass p-4 rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <label class="font-medium">画质等级</label>
                <select id="graphics-quality" class="glass-dark text-white border-none rounded px-3 py-1 focus:ring-2 focus:ring-primary">
                  <option value="high">高</option>
                  <option value="medium" selected>中</option>
                  <option value="low">低</option>
                </select>
              </div>
            </div>
            
            <div class="glass p-4 rounded-lg">
              <div class="flex justify-between items-center">
                <label class="font-medium">抗锯齿</label>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="anti-aliasing" class="sr-only peer" checked>
                  <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
              </div>
            </div>
            
            <div class="glass p-4 rounded-lg">
              <div class="flex justify-between items-center">
                <label class="font-medium">动态阴影</label>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="dynamic-shadows" class="sr-only peer" checked>
                  <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mb-8">
          <h3 class="text-xl font-semibold mb-4">飞行设置</h3>
          <div class="space-y-4">
            <div class="glass p-4 rounded-lg">
              <div class="flex justify-between items-center">
                <label class="font-medium">自动驾驶</label>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="auto-pilot" class="sr-only peer">
                  <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
              </div>
            </div>
            
            <div class="glass p-4 rounded-lg">
              <div class="flex justify-between items-center">
                <label class="font-medium">简化操作</label>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="simplified-controls" class="sr-only peer" checked>
                  <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                </label>
              </div>
            </div>
            
            <div class="glass p-4 rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <label class="font-medium">天气模式</label>
                <select id="weather-mode" class="glass-dark text-white border-none rounded px-3 py-1 focus:ring-2 focus:ring-primary">
                  <option value="clear" selected>晴朗</option>
                  <option value="cloudy">多云</option>
                  <option value="rainy">雨天</option>
                  <option value="stormy">暴风雨</option>
                  <option value="random">随机</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        
        <div>
          <h3 class="text-xl font-semibold mb-4">控制帮助</h3>
          <div class="glass p-4 rounded-lg">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-gray-300 mb-2"><span class="font-medium text-white">W/S/A/D</span> - 俯仰和滚转</p>
                <p class="text-sm text-gray-300 mb-2"><span class="font-medium text-white">↑/↓/←/→</span> - 方向舵和节流阀</p>
                <p class="text-sm text-gray-300"><span class="font-medium text-white">空格</span> - 刹车</p>
              </div>
              <div>
                <p class="text-sm text-gray-300 mb-2"><span class="font-medium text-white">1-5</span> - 切换视角</p>
                <p class="text-sm text-gray-300 mb-2"><span class="font-medium text-white">P</span> - 切换自动驾驶</p>
                <p class="text-sm text-gray-300"><span class="font-medium text-white">ESC</span> - 返回主菜单</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 飞行仪表盘 -->
    <div id="flight-instruments" class="absolute inset-0 pointer-events-none z-30 opacity-0 transition-opacity duration-1000">
      <!-- 顶部状态栏 -->
      <div class="glass-dark absolute top-4 left-4 right-4 h-12 rounded-full flex items-center px-6 justify-between pointer-events-auto">
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2">
            <i class="fa fa-plane text-primary"></i>
            <span id="plane-model">波音 737-800</span>
          </div>
          <div class="flex items-center gap-2">
            <i class="fa fa-map-marker text-secondary"></i>
            <span id="current-airport">JFK 肯尼迪国际机场</span>
          </div>
        </div>
        
        <div class="flex items-center gap-6">
          <div class="flex items-center gap-1">
            <i class="fa fa-clock-o text-gray-300"></i>
            <span id="flight-time">00:00:00</span>
          </div>
          <button id="open-settings-btn" class="btn-glass-dark p-2 rounded-full hover:scale-110 transition-transform">
            <i class="fa fa-cog"></i>
          </button>
          <button id="return-to-menu" class="btn-glass-dark p-2 rounded-full hover:scale-110 transition-transform">
            <i class="fa fa-home"></i>
          </button>
        </div>
      </div>
      
      <!-- 主仪表盘 - 底部 -->
      <div class="absolute bottom-4 left-4 right-4 glass-dark rounded-xl p-4 pointer-events-auto">
        <div class="grid grid-cols-12 gap-4 h-48">
          <!-- 空速表 -->
          <div class="col-span-3 cockpit-gauge bg-dark p-3 flex flex-col">
            <div class="text-center text-sm mb-1">空速</div>
            <div class="flex-1 flex items-center justify-center">
              <canvas id="airspeed-indicator" width="100" height="100"></canvas>
            </div>
            <div class="text-center text-xl font-bold" id="airspeed-value">320</div>
            <div class="text-center text-xs text-gray-400">km/h</div>
          </div>
          
          <!-- 高度表 -->
          <div class="col-span-3 cockpit-gauge bg-dark p-3 flex flex-col">
            <div class="text-center text-sm mb-1">高度</div>
            <div class="flex-1 flex items-center justify-center">
              <canvas id="altitude-indicator" width="100" height="100"></canvas>
            </div>
            <div class="text-center text-xl font-bold" id="altitude-value">9,800</div>
            <div class="text-center text-xs text-gray-400">米</div>
          </div>
          
          <!-- 航向表 -->
          <div class="col-span-3 cockpit-gauge bg-dark p-3 flex flex-col">
            <div class="text-center text-sm mb-1">航向</div>
            <div class="flex-1 flex items-center justify-center">
              <canvas id="heading-indicator" width="100" height="100"></canvas>
            </div>
            <div class="text-center text-xl font-bold" id="heading-value">275°</div>
            <div class="text-center text-xs text-gray-400" id="heading-direction">西</div>
          </div>
          
          <!-- 垂直速度表 -->
          <div class="col-span-3 cockpit-gauge bg-dark p-3 flex flex-col">
            <div class="text-center text-sm mb-1">垂直速度</div>
            <div class="flex-1 flex items-center justify-center">
              <canvas id="vertical-speed-indicator" width="100" height="100"></canvas>
            </div>
            <div class="text-center text-xl font-bold" id="vertical-speed-value">+500</div>
            <div class="text-center text-xs text-gray-400">米/分钟</div>
          </div>
        </div>
        
        <!-- 飞行控制条 -->
        <div class="mt-4 grid grid-cols-12 gap-4">
          <!-- 节流阀 -->
          <div class="col-span-5">
            <div class="flex justify-between items-center mb-1">
              <span class="text-sm">节流阀</span>
              <span class="text-sm font-medium" id="throttle-value">75%</span>
            </div>
            <div class="h-4 bg-dark rounded-full overflow-hidden">
              <div id="throttle-bar" class="h-full bg-primary rounded-full transition-all duration-150" style="width: 75%"></div>
            </div>
          </div>
          
          <!-- 襟翼 -->
          <div class="col-span-2">
            <div class="flex justify-between items-center mb-1">
              <span class="text-sm">襟翼</span>
              <span class="text-sm font-medium" id="flaps-value">0°</span>
            </div>
            <div class="h-4 bg-dark rounded-full overflow-hidden">
              <div id="flaps-bar" class="h-full bg-secondary rounded-full transition-all duration-150" style="width: 0%"></div>
            </div>
          </div>
          
          <!-- 视角选择 -->
          <div class="col-span-5 flex gap-2">
            <button class="view-btn flex-1 btn-glass-dark py-2 rounded text-sm active" data-view="cockpit">驾驶舱</button>
            <button class="view-btn flex-1 btn-glass-dark py-2 rounded text-sm" data-view="external">外部</button>
            <button class="view-btn flex-1 btn-glass-dark py-2 rounded text-sm" data-view="chase">追踪</button>
            <button class="view-btn flex-1 btn-glass-dark py-2 rounded text-sm" data-view="map">地图</button>
          </div>
        </div>
      </div>
      
      <!-- 自动驾驶面板 -->
      <div class="glass-dark absolute top-20 right-4 w-64 rounded-xl p-4 pointer-events-auto">
        <div class="flex justify-between items-center mb-3">
          <h3 class="font-medium">自动驾驶</h3>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="auto-pilot-toggle" class="sr-only peer">
            <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-primary"></div>
          </label>
        </div>
        
        <div class="space-y-3">
          <div>
            <label class="text-xs text-gray-400 block mb-1">目标高度 (米)</label>
            <div class="flex">
              <input type="number" id="target-altitude" value="10000" min="0" max="12000" class="glass-dark bg-dark/50 text-white border-none rounded-l px-3 py-2 w-full focus:ring-1 focus:ring-primary">
              <button id="set-altitude" class="bg-primary text-white px-3 rounded-r hover:bg-primary/80 transition-colors">
                <i class="fa fa-check"></i>
              </button>
            </div>
          </div>
          
          <div>
            <label class="text-xs text-gray-400 block mb-1">目标速度 (km/h)</label>
            <div class="flex">
              <input type="number" id="target-speed" value="450" min="100" max="900" class="glass-dark bg-dark/50 text-white border-none rounded-l px-3 py-2 w-full focus:ring-1 focus:ring-primary">
              <button id="set-speed" class="bg-primary text-white px-3 rounded-r hover:bg-primary/80 transition-colors">
                <i class="fa fa-check"></i>
              </button>
            </div>
          </div>
          
          <div>
            <label class="text-xs text-gray-400 block mb-1">目标航向 (°)</label>
            <div class="flex">
              <input type="number" id="target-heading" value="275" min="0" max="359" class="glass-dark bg-dark/50 text-white border-none rounded-l px-3 py-2 w-full focus:ring-1 focus:ring-primary">
              <button id="set-heading" class="bg-primary text-white px-3 rounded-r hover:bg-primary/80 transition-colors">
                <i class="fa fa-check"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 迷你地图 -->
      <div class="glass-dark absolute top-20 left-4 w-64 h-64 rounded-xl p-3 pointer-events-auto">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-medium">导航地图</h3>
          <div class="text-xs bg-gray-700 px-2 py-1 rounded">
            <i class="fa fa-compass mr-1"></i> <span id="map-scale">1:100000</span>
          </div>
        </div>
        <div class="bg-dark rounded-lg h-[calc(100%-24px)] relative overflow-hidden">
          <canvas id="mini-map" class="w-full h-full"></canvas>
          <!-- 地图上的飞机图标 -->
          <div id="map-plane" class="absolute w-4 h-4 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-primary transition-transform duration-100">
            <i class="fa fa-plane fa-lg"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 游戏状态管理
    const gameState = {
      isLoading: true,
      isPlaying: false,
      selectedPlane: 'boeing737',
      selectedAirport: 'jfk',
      viewMode: 'cockpit',
      flightTime: 0,
      autopilot: false,
      weather: 'clear',
      
      // 飞行参数
      altitude: 0,
      airspeed: 0,
      heading: 275,
      verticalSpeed: 0,
      throttle: 0,
      flaps: 0,
      pitch: 0,
      roll: 0,
      yaw: 0,
      
      // 目标参数 (自动驾驶)
      targetAltitude: 10000,
      targetSpeed: 450,
      targetHeading: 275,
      
      // 位置信息
      position: { x: 0, y: 0, z: 0 }
    };
    
    // 初始化Three.js场景
    let scene, camera, renderer, controls;
    let planeModel, skybox, ground;
    let clock = new THREE.Clock();
    let animationFrameId;
    
    // DOM元素
    const elements = {
      loadingScreen: document.getElementById('loading-screen'),
      loadingProgress: document.getElementById('loading-progress'),
      mainMenu: document.getElementById('main-menu'),
      planeSelector: document.getElementById('plane-selector'),
      airportSelector: document.getElementById('airport-selector'),
      settingsMenu: document.getElementById('settings-menu'),
      flightInstruments: document.getElementById('flight-instruments'),
      gameCanvas: document.getElementById('game-canvas'),
      
      // 按钮
      startGameBtn: document.getElementById('start-game'),
      selectPlaneBtn: document.getElementById('select-plane'),
      selectAirportBtn: document.getElementById('select-airport'),
      settingsBtn: document.getElementById('settings'),
      backFromPlaneBtn: document.getElementById('back-from-plane'),
      backFromAirportBtn: document.getElementById('back-from-airport'),
      backFromSettingsBtn: document.getElementById('back-from-settings'),
      returnToMenuBtn: document.getElementById('return-to-menu'),
      openSettingsBtn: document.getElementById('open-settings-btn'),
      autoPilotToggle: document.getElementById('auto-pilot-toggle'),
      
      // 指示器
      airspeedValue: document.getElementById('airspeed-value'),
      altitudeValue: document.getElementById('altitude-value'),
      headingValue: document.getElementById('heading-value'),
      headingDirection: document.getElementById('heading-direction'),
      verticalSpeedValue: document.getElementById('vertical-speed-value'),
      throttleValue: document.getElementById('throttle-value'),
      throttleBar: document.getElementById('throttle-bar'),
      flapsValue: document.getElementById('flaps-value'),
      flapsBar: document.getElementById('flaps-bar'),
      flightTimeDisplay: document.getElementById('flight-time'),
      planeModelDisplay: document.getElementById('plane-model'),
      currentAirportDisplay: document.getElementById('current-airport'),
      
      // 画布
      airspeedIndicator: document.getElementById('airspeed-indicator'),
      altitudeIndicator: document.getElementById('altitude-indicator'),
      headingIndicator: document.getElementById('heading-indicator'),
      verticalSpeedIndicator: document.getElementById('vertical-speed-indicator'),
      miniMap: document.getElementById('mini-map')
    };
    
    // 初始化游戏
    function initGame() {
      // 设置画布尺寸
      elements.gameCanvas.width = window.innerWidth;
      elements.gameCanvas.height = window.innerHeight;
      
      // 初始化Three.js
      initThreeJS();
      
      // 初始化仪表盘
      initInstruments();
      
      // 加载游戏资源
      loadGameAssets();
      
      // 设置事件监听
      setupEventListeners();
      
      // 开始加载进度模拟
      simulateLoading();
    }
    
    // 初始化Three.js场景
    function initThreeJS() {
      // 创建场景
      scene = new THREE.Scene();
      
      // 创建相机
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
      camera.position.z = 5;
      
      // 创建渲染器
      renderer = new THREE.WebGLRenderer({ 
        canvas: elements.gameCanvas,
        antialias: true,
        alpha: true
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      
      // 添加环境光
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);
      
      // 添加方向光
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(100, 100, 100);
      directionalLight.castShadow = true;
      scene.add(directionalLight);
      
      // 设置阴影属性
      directionalLight.shadow.mapSize.width = 2048;
      directionalLight.shadow.mapSize.height = 2048;
      directionalLight.shadow.camera.near = 0.5;
      directionalLight.shadow.camera.far = 500;
      
      // 添加控制器
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      
      // 创建天空盒
      createSkybox();
      
      // 创建地面
      createGround();
    }
    
    // 创建天空盒
    function createSkybox() {
      const skyboxGeometry = new THREE.BoxGeometry(10000, 10000, 10000);
      
      // 晴朗天空纹理
      const skyboxMaterials = [
        new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load('https://picsum.photos/id/1015/512/512'), side: THREE.BackSide }),
        new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load('https://picsum.photos/id/1016/512/512'), side: THREE.BackSide }),
        new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load('https://picsum.photos/id/1018/512/512'), side: THREE.BackSide }),
        new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load('https://picsum.photos/id/1019/512/512'), side: THREE.BackSide }),
        new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load('https://picsum.photos/id/1039/512/512'), side: THREE.BackSide }),
        new THREE.MeshBasicMaterial({ map: new THREE.TextureLoader().load('https://picsum.photos/id/1040/512/512'), side: THREE.BackSide })
      ];
      
      skybox = new THREE.Mesh(skyboxGeometry, skyboxMaterials);
      scene.add(skybox);
    }
    
    // 创建地面
    function createGround() {
      const groundGeometry = new THREE.PlaneGeometry(10000, 10000, 100, 100);
      const groundMaterial = new THREE.MeshStandardMaterial({
        color: 0x228b22,
        wireframe: false
      });
      
      ground = new THREE.Mesh(groundGeometry, groundMaterial);
      ground.rotation.x = -Math.PI / 2;
      ground.position.y = -100;
      ground.receiveShadow = true;
      scene.add(ground);
      
      // 添加一些地形变化
      for (let i = 0; i < groundGeometry.vertices.length; i++) {
        const vertex = groundGeometry.vertices[i];
        vertex.y = Math.sin(vertex.x * 0.01) * 5 + Math.cos(vertex.z * 0.01) * 5;
      }
      groundGeometry.computeVertexNormals();
    }
    
    // 初始化仪表盘
    function initInstruments() {
      // 空速表
      const airspeedCtx = elements.airspeedIndicator.getContext('2d');
      createGauge(airspeedCtx, 0, 1000, 100, 'km/h');
      
      // 高度表
      const altitudeCtx = elements.altitudeIndicator.getContext('2d');
      createGauge(altitudeCtx, 0, 12000, 2000, 'm');
      
      // 航向表
      const headingCtx = elements.headingIndicator.getContext('2d');
      createCompass(headingCtx);
      
      // 垂直速度表
      const vsCtx = elements.verticalSpeedIndicator.getContext('2d');
      createVerticalSpeedGauge(vsCtx);
      
      // 迷你地图
      const mapCtx = elements.miniMap.getContext('2d');
      drawMiniMap(mapCtx);
    }
    
    // 创建通用仪表盘
    function createGauge(ctx, min, max, step, unit) {
      const width = ctx.canvas.width;
      const height = ctx.canvas.height;
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) / 2 - 5;
      
      // 清除画布
      ctx.clearRect(0, 0, width, height);
      
      // 绘制刻度背景
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0.2 * Math.PI, 1.8 * Math.PI);
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // 绘制刻度
      const totalSteps = (max - min) / step;
      const angleStep = (1.6 * Math.PI) / totalSteps;
      
      for (let i = 0; i <= totalSteps; i++) {
        const angle = 0.2 * Math.PI + i * angleStep;
        const outerX = centerX + Math.cos(angle) * radius;
        const outerY = centerY + Math.sin(angle) * radius;
        const innerX = centerX + Math.cos(angle) * (radius - (i % 5 === 0 ? 10 : 5));
        const innerY = centerY + Math.sin(angle) * (radius - (i % 5 === 0 ? 10 : 5));
        
        ctx.beginPath();
        ctx.moveTo(outerX, outerY);
        ctx.lineTo(innerX, innerY);
        ctx.strokeStyle = i % 5 === 0 ? 'rgba(255, 255, 255, 0.8)' : 'rgba(255, 255, 255, 0.4)';
        ctx.lineWidth = i % 5 === 0 ? 2 : 1;
        ctx.stroke();
        
        // 绘制主要刻度的数字
        if (i % 5 === 0) {
          const label = min + i * step;
          const textX = centerX + Math.cos(angle) * (radius - 20);
          const textY = centerY + Math.sin(angle) * (radius - 20);
          
          ctx.font = '10px SF Pro Display';
          ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(label, textX, textY);
        }
      }
    }
    
    // 创建罗盘
    function createCompass(ctx) {
      const width = ctx.canvas.width;
      const height = ctx.canvas.height;
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) / 2 - 5;
      
      // 清除画布
      ctx.clearRect(0, 0, width, height);
      
      // 绘制罗盘背景
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.fillStyle = 'rgba(0, 50, 100, 0.3)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // 绘制方向标记
      const directions = ['N', 'E', 'S', 'W'];
      for (let i = 0; i < 4; i++) {
        const angle = i * Math.PI / 2;
        const textX = centerX + Math.cos(angle) * (radius - 15);
        const textY = centerY + Math.sin(angle) * (radius - 15);
        
        ctx.font = '12px SF Pro Display bold';
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(directions[i], textX, textY);
      }
      
      // 绘制刻度
      for (let i = 0; i < 36; i++) {
        const angle = (i * 10) * Math.PI / 180;
        const outerX = centerX + Math.cos(angle) * radius;
        const outerY = centerY + Math.sin(angle) * radius;
        const innerX = centerX + Math.cos(angle) * (radius - (i % 3 === 0 ? 10 : 5));
        const innerY = centerY + Math.sin(angle) * (radius - (i % 3 === 0 ? 10 : 5));
        
        ctx.beginPath();
        ctx.moveTo(outerX, outerY);
        ctx.lineTo(innerX, innerY);
        ctx.strokeStyle = i % 9 === 0 ? 'white' : (i % 3 === 0 ? 'rgba(255, 255, 255, 0.7)' : 'rgba(255, 255, 255, 0.4)');
        ctx.lineWidth = i % 9 === 0 ? 2 : 1;
        ctx.stroke();
        
        // 绘制主要刻度的数字
        if (i % 9 === 0 && i !== 0) {
          const label = i * 10;
          const textX = centerX + Math.cos(angle) * (radius - 20);
          const textY = centerY + Math.sin(angle) * (radius - 20);
          
          ctx.font = '10px SF Pro Display';
          ctx.fillStyle = 'white';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(label, textX, textY);
        }
      }
    }
    
    // 创建垂直速度表
    function createVerticalSpeedGauge(ctx) {
      const width = ctx.canvas.width;
      const height = ctx.canvas.height;
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) / 2 - 5;
      
      // 清除画布
      ctx.clearRect(0, 0, width, height);
      
      // 绘制刻度背景
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0.2 * Math.PI, 1.8 * Math.PI);
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // 绘制正负区域
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0.2 * Math.PI, 1 * Math.PI);
      ctx.lineTo(centerX, centerY);
      ctx.closePath();
      ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
      ctx.fill();
      
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 1 * Math.PI, 1.8 * Math.PI);
      ctx.lineTo(centerX, centerY);
      ctx.closePath();
      ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';
      ctx.fill();
      
      // 绘制刻度
      const speeds = [-2000, -1500, -1000, -500, 0, 500, 1000, 1500, 2000];
      const angleStep = (1.6 * Math.PI) / (speeds.length - 1);
      
      for (let i = 0; i < speeds.length; i++) {
        const angle = 0.2 * Math.PI + i * angleStep;
        const outerX = centerX + Math.cos(angle) * radius;
        const outerY = centerY + Math.sin(angle) * radius;
        const innerX = centerX + Math.cos(angle) * (radius - 10);
        const innerY = centerY + Math.sin(angle) * (radius - 10);
        
        ctx.beginPath();
        ctx.moveTo(outerX, outerY);
        ctx.lineTo(innerX, innerY);
        ctx.strokeStyle = speeds[i] === 0 ? 'white' : 'rgba(255, 255, 255, 0.6)';
        ctx.lineWidth = speeds[i] === 0 ? 3 : 2;
        ctx.stroke();
        
        // 绘制数字
        const textX = centerX + Math.cos(angle) * (radius - 20);
        const textY = centerY + Math.sin(angle) * (radius - 20);
        
        ctx.font = '10px SF Pro Display';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(speeds[i] > 0 ? '+' + speeds[i] : speeds[i], textX, textY);
      }
    }
    
    // 绘制迷你地图
    function drawMiniMap(ctx) {
      const width = ctx.canvas.width;
      const height = ctx.canvas.height;
      
      // 清除画布
      ctx.clearRect(0, 0, width, height);
      
      // 绘制地图背景
      ctx.fillStyle = 'rgba(30, 30, 40, 0.8)';
      ctx.fillRect(0, 0, width, height);
      
      // 绘制网格
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.lineWidth = 1;
      
      // 水平线
      for (let i = 0; i <= 10; i++) {
        const y = (height / 10) * i;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }
      
      // 垂直线
      for (let i = 0; i <= 10; i++) {
        const x = (width / 10) * i;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }
      
      // 绘制机场位置
      const airportX = width / 2;
      const airportY = height - 40;
      
      ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
      ctx.beginPath();
      ctx.arc(airportX, airportY, 5, 0, 2 * Math.PI);
      ctx.fill();
      
      // 绘制跑道
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(airportX - 30, airportY);
      ctx.lineTo(airportX + 30, airportY);
      ctx.stroke();
    }
    
    // 更新仪表盘
    function updateInstruments() {
      // 更新空速表
      updateGauge(
        elements.airspeedIndicator.getContext('2d'), 
        gameState.airspeed, 
        0, 1000, 
        0.2 * Math.PI, 1.8 * Math.PI
      );
      
      // 更新高度表
      updateGauge(
        elements.altitudeIndicator.getContext('2d'), 
        gameState.altitude, 
        0, 12000, 
        0.2 * Math.PI, 1.8 * Math.PI
      );
      
      // 更新航向表
      updateCompass(elements.headingIndicator.getContext('2d'), gameState.heading);
      
      // 更新垂直速度表
      updateVerticalSpeedGauge(
        elements.verticalSpeedIndicator.getContext('2d'), 
        gameState.verticalSpeed
      );
      
      // 更新数值显示
      elements.airspeedValue.textContent = Math.round(gameState.airspeed);
      elements.altitudeValue.textContent = Math.round(gameState.altitude).toLocaleString();
      elements.headingValue.textContent = Math.round(gameState.heading) + '°';
      
      // 更新航向方向
      const directions = ['北', '东北', '东', '东南', '南', '西南', '西', '西北'];
      const dirIndex = Math.round((gameState.heading % 360) / 45) % 8;
      elements.headingDirection.textContent = directions[dirIndex];
      
      // 更新垂直速度
      elements.verticalSpeedValue.textContent = gameState.verticalSpeed >= 0 ? 
        '+' + Math.round(gameState.verticalSpeed) : 
        Math.round(gameState.verticalSpeed);
      
      // 更新节流阀
      elements.throttleValue.textContent = Math.round(gameState.throttle * 100) + '%';
      elements.throttleBar.style.width = (gameState.throttle * 100) + '%';
      
      // 更新襟翼
      elements.flapsValue.textContent = Math.round(gameState.flaps * 40) + '°';
      elements.flapsBar.style.width = (gameState.flaps * 100) + '%';
      
      // 更新飞行时间
      const hours = Math.floor(gameState.flightTime / 3600).toString().padStart(2, '0');
      const minutes = Math.floor((gameState.flightTime % 3600) / 60).toString().padStart(2, '0');
      const seconds = Math.floor(gameState.flightTime % 60).toString().padStart(2, '0');
      elements.flightTimeDisplay.textContent = `${hours}:${minutes}:${seconds}`;
      
      // 更新地图上的飞机位置和方向
      const mapPlane = document.getElementById('map-plane');
      mapPlane.style.transform = `translate(-50%, -50%) rotate(${gameState.heading}deg)`;
    }
    
    // 更新通用仪表盘
    function updateGauge(ctx, value, min, max, startAngle, endAngle) {
      const width = ctx.canvas.width;
      const height = ctx.canvas.height;
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) / 2 - 5;
      
      // 保存当前状态
      ctx.save();
      
      // 清除指针区域
      ctx.clearRect(0, 0, width, height);
      
      // 重绘刻度背景
      createGauge(ctx, min, max, (max - min) / 10, '');
      
      // 计算指针角度
      const range = max - min;
      const normalizedValue = Math.max(0, Math.min(1, (value - min) / range));
      const angle = startAngle + normalizedValue * (endAngle - startAngle);
      
      // 绘制指针
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(
        centerX + Math.cos(angle) * (radius - 5),
        centerY + Math.sin(angle) * (radius - 5)
      );
      ctx.strokeStyle = '#0071e3';
      ctx.lineWidth = 3;
      ctx.stroke();
      
      // 绘制中心点
      ctx.beginPath();
      ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
      ctx.fillStyle = '#0071e3';
      ctx.fill();
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 1;
      ctx.stroke();
      
      // 恢复状态
      ctx.restore();
    }
    
    // 更新罗盘
    function updateCompass(ctx, heading) {
      const width = ctx.canvas.width;
      const height = ctx.canvas.height;
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) / 2 - 5;
      
      // 保存当前状态
      ctx.save();
      
      // 清除画布
      ctx.clearRect(0, 0, width, height);
      
      // 旋转画布以模拟罗盘旋转
      ctx.translate(centerX, centerY);
      ctx.rotate(-heading * Math.PI / 180);
      ctx.translate(-centerX, -centerY);
      
      // 重绘罗盘
      createCompass(ctx);
      
      // 恢复状态
      ctx.restore();
      
      // 绘制固定指针
      ctx.beginPath();
      ctx.moveTo(centerX, centerY - radius / 2);
      ctx.lineTo(centerX, centerY + radius / 4);
      ctx.lineWidth = 3;
      ctx.strokeStyle = '#ff3b30';
      ctx.stroke();
      
      ctx.beginPath();
      ctx.arc(centerX, centerY - radius / 2, 5, 0, 2 * Math.PI);
      ctx.fillStyle = '#ff3b30';
      ctx.fill();
      
      // 绘制中心点
      ctx.beginPath();
      ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
      ctx.fillStyle = '#0071e3';
      ctx.fill();
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 1;
      ctx.stroke();
    }
    
    // 更新垂直速度表
    function updateVerticalSpeedGauge(ctx, speed) {
      const width = ctx.canvas.width;
      const height = ctx.canvas.height;
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) / 2 - 5;
      
      // 保存当前状态
      ctx.save();
      
      // 清除画布
      ctx.clearRect(0, 0, width, height);
      
      // 重绘速度表背景
      createVerticalSpeedGauge(ctx);
      
      // 计算指针角度 (-2000 到 2000)
      const normalizedSpeed = Math.max(-1, Math.min(1, speed / 2000));
      const angle = 1 * Math.PI - normalizedSpeed * 0.8 * Math.PI;
      
      // 绘制指针
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(
        centerX + Math.cos(angle) * (radius - 5),
        centerY + Math.sin(angle) * (radius - 5)
      );
      ctx.strokeStyle = speed > 0 ? '#34c759' : '#ff3b30';
      ctx.lineWidth = 3;
      ctx.stroke();
      
      // 绘制中心点
      ctx.beginPath();
      ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
      ctx.fillStyle = '#0071e3';
      ctx.fill();
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 1;
      ctx.stroke();
      
      // 恢复状态
      ctx.restore();
    }
    
    // 加载游戏资源
    function loadGameAssets() {
      // 这里使用简单的飞机模型代替真实的3D模型加载
      const loader = new THREE.GLTFLoader();
      
      // 根据选择的飞机加载不同模型
      let modelUrl = 'https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf'; // 默认模型
      
      if (gameState.selectedPlane === 'cessna') {
        modelUrl = 'https://threejs.org/examples/models/gltf/LittlestTokyo.gltf';
      } else if (gameState.selectedPlane === 'boeing737') {
        modelUrl = 'https://threejs.org/examples/models/gltf/IridescentDishWithOlives.gltf';
      } else if (gameState.selectedPlane === 'f16') {
        modelUrl = 'https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf';
      }
      
      loader.load(
        modelUrl,
        (gltf) => {
          planeModel = gltf.scene;
          
          // 设置模型属性
          planeModel.scale.set(0.5, 0.5, 0.5);
          planeModel.position.set(0, 0, 0);
          planeModel.castShadow = true;
          
          scene.add(planeModel);
          
          // 更新加载进度
          updateLoadingProgress(80);
        },
        (xhr) => {
          const percent = 60 + (xhr.loaded / xhr.total) * 20;
          updateLoadingProgress(percent);
        },
        (error) => {
          console.error('模型加载错误:', error);
        }
      );
    }
    
    // 模拟加载过程
    function simulateLoading() {
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 5;
        if (progress >= 60) {
          progress = 60;
          clearInterval(interval);
          
          // 等待模型加载完成后完成加载
          setTimeout(() => {
            updateLoadingProgress(100);
            setTimeout(() => {
              elements.loadingScreen.style.opacity = 0;
              setTimeout(() => {
                elements.loadingScreen.style.display = 'none';
                gameState.isLoading = false;
              }, 1000);
            }, 500);
          }, 1000);
        }
        updateLoadingProgress(progress);
      }, 300);
    }
    
    // 更新加载进度
    function updateLoadingProgress(percent) {
      elements.loadingProgress.style.width = percent + '%';
    }
    
    // 设置事件监听
    function setupEventListeners() {
      // 菜单导航
      elements.startGameBtn.addEventListener('click', startGame);
      elements.selectPlaneBtn.addEventListener('click', () => {
        elements.mainMenu.classList.add('translate-x-full');
        elements.planeSelector.classList.remove('translate-x-full');
      });
      
      elements.backFromPlaneBtn.addEventListener('click', () => {
        elements.planeSelector.classList.add('translate-x-full');
        elements.mainMenu.classList.remove('translate-x-full');
      });
      
      elements.selectAirportBtn.addEventListener('click', () => {
        elements.mainMenu.classList.add('translate-x-full');
        elements.airportSelector.classList.remove('translate-x-full');
      });
      
      elements.backFromAirportBtn.addEventListener('click', () => {
        elements.airportSelector.classList.add('translate-x-full');
        elements.mainMenu.classList.remove('translate-x-full');
      });
      
      elements.settingsBtn.addEventListener('click', () => {
        elements.mainMenu.classList.add('translate-x-full');
        elements.settingsMenu.classList.remove('translate-x-full');
      });
      
      elements.backFromSettingsBtn.addEventListener('click', () => {
        elements.settingsMenu.classList.add('translate-x-full');
        elements.mainMenu.classList.remove('translate-x-full');
      });
      
      elements.returnToMenuBtn.addEventListener('click', returnToMenu);
      elements.openSettingsBtn.addEventListener('click', () => {
        elements.flightInstruments.style.opacity = 0;
        setTimeout(() => {
          elements.settingsMenu.classList.remove('translate-x-full');
        }, 500);
      });
      
      // 选择飞机
      document.querySelectorAll('.plane-card').forEach(card => {
        card.addEventListener('click', () => {
          gameState.selectedPlane = card.dataset.plane;
          
          // 更新显示
          let planeName = '';
          if (gameState.selectedPlane === 'cessna') planeName = '塞斯纳 172';
          else if (gameState.selectedPlane === 'boeing737') planeName = '波音 737-800';
          else if (gameState.selectedPlane === 'f16') planeName = 'F-16 战隼';
          
          elements.planeModelDisplay.textContent = planeName;
          
          // 重新加载飞机模型
          if (planeModel) {
            scene.remove(planeModel);
          }
          loadGameAssets();
          
          // 返回主菜单
          elements.planeSelector.classList.add('translate-x-full');
          elements.mainMenu.classList.remove('translate-x-full');
        });
      });
      
      // 选择机场
      document.querySelectorAll('.airport-card').forEach(card => {
        card.addEventListener('click', () => {
          gameState.selectedAirport = card.dataset.airport;
          
          // 更新显示
          let airportName = '';
          if (gameState.selectedAirport === 'jfk') airportName = 'JFK 肯尼迪国际机场';
          else if (gameState.selectedAirport === 'heathrow') airportName = '希思罗国际机场';
          else if (gameState.selectedAirport === 'shanghai') airportName = '浦东国际机场';
          else if (gameState.selectedAirport === 'alps') airportName = '阿尔卑斯山区机场';
          
          elements.currentAirportDisplay.textContent = airportName;
          
          // 返回主菜单
          elements.airportSelector.classList.add('translate-x-full');
          elements.mainMenu.classList.remove('translate-x-full');
        });
      });
      
      // 视角切换
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('bg-primary/30'));
          btn.classList.add('bg-primary/30');
          gameState.viewMode = btn.dataset.view;
          updateCameraPosition();
        });
      });
      
      // 自动驾驶切换
      elements.autoPilotToggle.addEventListener('change', (e) => {
        gameState.autopilot = e.target.checked;
      });
      
      // 窗口大小调整
      window.addEventListener('resize', onWindowResize);
      
      // 键盘控制
      window.addEventListener('keydown', handleKeyDown);
      window.addEventListener('keyup', handleKeyUp);
      
      // 自动驾驶设置
      document.getElementById('set-altitude').addEventListener('click', () => {
        const alt = parseInt(document.getElementById('target-altitude').value);
        if (!isNaN(alt)) {
          gameState.targetAltitude = alt;
        }
      });
      
      document.getElementById('set-speed').addEventListener('click', () => {
        const speed = parseInt(document.getElementById('target-speed').value);
        if (!isNaN(speed)) {
          gameState.targetSpeed = speed;
        }
      });
      
      document.getElementById('set-heading').addEventListener('click', () => {
        const heading = parseInt(document.getElementById('target-heading').value);
        if (!isNaN(heading)) {
          gameState.targetHeading = heading % 360;
        }
      });
      
      // ESC键返回菜单
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && gameState.isPlaying) {
          returnToMenu();
        }
      });
    }
    
    // 窗口大小调整
    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
    
    // 键盘按下处理
    function handleKeyDown(e) {
      if (!gameState.isPlaying) return;
      
      // 禁用自动驾驶当手动控制时
      if (![' ', 'p', 'Escape'].includes(e.key)) {
        gameState.autopilot = false;
        elements.autoPilotToggle.checked = false;
      }
      
      switch(e.key.toLowerCase()) {
        case 'w': // 抬头
          gameState.pitch = -0.02;
          break;
        case 's': // 低头
          gameState.pitch = 0.02;
          break;
        case 'a': // 左滚转
          gameState.roll = -0.02;
          break;
        case 'd': // 右滚转
          gameState.roll = 0.02;
          break;
        case 'arrowup': // 增加节流阀
          gameState.throttle = Math.min(1, gameState.throttle + 0.01);
          break;
        case 'arrowdown': // 减少节流阀
          gameState.throttle = Math.max(0, gameState.throttle - 0.01);
          break;
        case 'arrowleft': // 左偏航
          gameState.yaw = -0.2;
          break;
        case 'arrowright': // 右偏航
          gameState.yaw = 0.2;
          break;
        case ' ': // 刹车
          gameState.throttle = Math.max(0, gameState.throttle - 0.02);
          break;
        case 'f': // 襟翼
          gameState.flaps = gameState.flaps < 1 ? 1 : 0;
          break;
        case 'p': // 自动驾驶切换
          gameState.autopilot = !gameState.autopilot;
          elements.autoPilotToggle.checked = gameState.autopilot;
          break;
        case '1': // 驾驶舱视角
          setViewMode('cockpit');
          break;
        case '2': // 外部视角
          setViewMode('external');
          break;
        case '3': // 追踪视角
          setViewMode('chase');
          break;
        case '4': // 地图视角
          setViewMode('map');
          break;
      }
    }
    
    // 键盘释放处理
    function handleKeyUp(e) {
      switch(e.key.toLowerCase()) {
        case 'w':
        case 's':
          gameState.pitch = 0;
          break;
        case 'a':
        case 'd':
          gameState.roll = 0;
          break;
        case 'arrowleft':
        case 'arrowright':
          gameState.yaw = 0;
          break;
      }
    }
    
    // 设置视角模式
    function setViewMode(mode) {
      gameState.viewMode = mode;
      document.querySelectorAll('.view-btn').forEach(btn => {
        if (btn.dataset.view === mode) {
          btn.classList.add('bg-primary/30');
        } else {
          btn.classList.remove('bg-primary/30');
        }
      });
      updateCameraPosition();
    }
    
    // 开始游戏
    function startGame() {
      gameState.isPlaying = true;
      gameState.flightTime = 0;
      gameState.altitude = 0;
      gameState.airspeed = 0;
      gameState.heading = 275;
      gameState.verticalSpeed = 0;
      gameState.throttle = 0;
      gameState.flaps = 0;
      gameState.pitch = 0;
      gameState.roll = 0;
      gameState.yaw = 0;
      
      // 隐藏主菜单
      elements.mainMenu.classList.add('translate-x-full');
      
      // 显示飞行仪表
      setTimeout(() => {
        elements.flightInstruments.style.opacity = 1;
      }, 500);
      
      // 开始游戏循环
      animate();
    }
    
    // 返回主菜单
    function returnToMenu() {
      gameState.isPlaying = false;
      
      // 隐藏飞行仪表
      elements.flightInstruments.style.opacity = 0;
      
      // 隐藏设置菜单
      elements.settingsMenu.classList.add('translate-x-full');
      
      // 显示主菜单
      setTimeout(() => {
        elements.mainMenu.classList.remove('translate-x-full');
      }, 500);
      
      // 停止动画循环
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }
    }
    
    // 更新相机位置
    function updateCameraPosition() {
      if (!planeModel) return;
      
      const planePos = planeModel.position;
      const planeRot = planeModel.rotation;
      
      switch(gameState.viewMode) {
        case 'cockpit':
          camera.position.set(
            planePos.x - Math.sin(planeRot.y) * 2,
            planePos.y + 1.5,
            planePos.z + Math.cos(planeRot.y) * 2
          );
          camera.lookAt(
            planePos.x - Math.sin(planeRot.y) * 100,
            planePos.y + Math.sin(planeRot.x) * 100,
            planePos.z + Math.cos(planeRot.y) * 100
          );
          break;
          
        case 'external':
          camera.position.set(
            planePos.x - Math.sin(planeRot.y) * 15,
            planePos.y + 8,
            planePos.z + Math.cos(planeRot.y) * 15
          );
          camera.lookAt(planePos.x, planePos.y + 2, planePos.z);
          break;
          
        case 'chase':
          camera.position.set(
            planePos.x - Math.sin(planeRot.y) * 20,
            planePos.y + 5,
            planePos.z + Math.cos(planeRot.y) * 20
          );
          camera.lookAt(
            planePos.x - Math.sin(planeRot.y) * 50,
            planePos.y + 5 + Math.sin(planeRot.x) * 50,
            planePos.z + Math.cos(planeRot.y) * 50
          );
          break;
          
        case 'map':
          camera.position.set(0, 500, 0);
          camera.lookAt(0, 0, 0);
          camera.rotation.x = -Math.PI / 2;
          break;
      }
    }
    
    // 应用自动驾驶
    function applyAutopilot(deltaTime) {
      // 高度控制
      const altitudeDiff = gameState.targetAltitude - gameState.altitude;
      if (Math.abs(altitudeDiff) > 50) {
        gameState.pitch = Math.max(-0.02, Math.min(0.02, altitudeDiff / 1000));
      } else {
        gameState.pitch = 0;
        gameState.verticalSpeed = 0;
      }
      
      // 速度控制
      const speedDiff = gameState.targetSpeed - gameState.airspeed;
      if (Math.abs(speedDiff) > 20) {
        gameState.throttle = Math.max(0, Math.min(1, gameState.throttle + speedDiff / 10000));
      }
      
      // 航向控制
      let headingDiff = gameState.targetHeading - gameState.heading;
      if (headingDiff > 180) headingDiff -= 360;
      if (headingDiff < -180) headingDiff += 360;
      
      if (Math.abs(headingDiff) > 5) {
        gameState.yaw = Math.max(-0.2, Math.min(0.2, headingDiff / 100));
      } else {
        gameState.yaw = 0;
      }
    }
    
    // 游戏主循环
    function animate() {
      if (!gameState.isPlaying) return;
      
      animationFrameId = requestAnimationFrame(animate);
      
      const deltaTime = clock.getDelta();
      
      // 更新飞行时间
      gameState.flightTime += deltaTime;
      
      // 应用自动驾驶
      if (gameState.autopilot) {
        applyAutopilot(deltaTime);
      }
      
      // 计算空速 (基于节流阀和襟翼)
      const baseSpeed = gameState.throttle * (
        gameState.selectedPlane === 'f16' ? 2000 : 
        gameState.selectedPlane === 'boeing737' ? 900 : 200
      );
      const flapEffect = 1 - (gameState.flaps * 0.3); // 襟翼增加阻力
      gameState.airspeed = Math.max(0, gameState.airspeed + (baseSpeed - gameState.airspeed) * 0.05);
      gameState.airspeed *= flapEffect;
      
      // 计算垂直速度 (基于俯仰角和空速)
      const pitchEffect = gameState.pitch * 500;
      gameState.verticalSpeed = pitchEffect * (gameState.airspeed / 1000) * 60;
      
      // 更新高度
      gameState.altitude = Math.max(0, gameState.altitude + (gameState.verticalSpeed / 60) * deltaTime);
      
      // 更新航向
      gameState.heading = (gameState.heading + gameState.yaw * deltaTime * 30) % 360;
      if (gameState.heading < 0) gameState.heading += 360;
      
      // 更新飞机位置
      if (planeModel) {
        // 基于航向和空速计算移动距离
        const moveDistance = (gameState.airspeed / 3600) * 1000 * deltaTime;
        const radians = gameState.heading * Math.PI / 180;
        
        planeModel.position.x -= Math.sin(radians) * moveDistance;
        planeModel.position.z += Math.cos(radians) * moveDistance;
        planeModel.position.y = gameState.altitude;
        
        // 更新飞机旋转
        planeModel.rotation.x = gameState.pitch * 5;
        planeModel.rotation.z = gameState.roll * 5;
        planeModel.rotation.y = -radians;
      }
      
      // 更新相机位置
      updateCameraPosition();
      
      // 更新仪表盘
      updateInstruments();
      
      // 渲染场景
      renderer.render(scene, camera);
      
      // 更新控制器
      controls.update();
    }
    
    // 初始化游戏
    window.addEventListener('DOMContentLoaded', initGame);
  </script>
</body>
</html>
